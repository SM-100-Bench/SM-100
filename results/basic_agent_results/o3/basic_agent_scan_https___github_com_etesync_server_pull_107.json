{"repo_id": "etesync_server_107", "bugs": [{"description": "Incorrect parameter name 'expire' is used in aioredis 'set' command. Redis-py/aioredis expects 'ex' (seconds) or 'px' (milliseconds). Using 'expire' will raise a TypeError (unexpected keyword argument) and prevent ticket creation, breaking websocket authentication flow.", "file": "etebase_fastapi/routers/websocket.py", "line": 54}, {"description": "load_websocket_ticket() uses redisw.redis even when redisw.is_active is False. If Redis is not configured, redis attribute is never initialised, so accessing redisw.redis raises AttributeError, crashing the endpoint. Function should verify redisw.is_active or raise NotSupported before using redis.", "file": "etebase_fastapi/routers/websocket.py", "line": 58}, {"description": "Ticket expiry uses `expire=TICKET_VALIDITY_SECONDS * 1000` (milliseconds) while aioredis expects seconds for the `expire` parameter. This makes tickets valid for ~2.7 hours instead of 10 seconds, weakening security and keeping stale keys in Redis.", "file": "etebase_fastapi/routers/websocket.py", "line": 54}, {"description": "`send_item_updates` never forwards the updated `stoken` returned in `response.stoken` to the next iteration. If more than 50 updates are pending the `done` flag will stay `False`, but `stoken` remains the old value, so every loop fetches the same first page, causing an infinite loop, high CPU usage and websocket flooding.", "file": "etebase_fastapi/routers/websocket.py", "line": 95}, {"description": "`websocket_endpoint` declares both `user` (obtained via Depends(get_websocket_user)) and `ticket_model` (Depends(load_websocket_ticket)). `get_websocket_user` already calls `load_websocket_ticket`, which *deletes* the ticket from Redis. When the second dependency executes, the ticket no longer exists and `load_websocket_ticket` returns `None`, so `ticket_model` is `None`. Later, `redis_connector` accesses `ticket_model.req`, raising AttributeError and breaking the websocket. The same ticket should be loaded only once and shared between dependencies.", "file": "etebase_fastapi/routers/websocket.py", "line": 74}], "updated_files": {}}